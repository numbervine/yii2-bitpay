<?php
namespace numbervine\bitpay\widgets;

use numbervine\bitpay\assets\BitpayAsset;
use yii\base\Widget;
use yii\helpers\Html;
use yii\bootstrap\Modal;
use yii\web\View;

class BitpayWidget extends Widget
{
  public $options = [];
  public $htmlOptions = [];

  public $invoice_id;
  public $invoice_amount;
  public $customer_id;

  public function init()
  {
    parent::init();
    \Yii::$app->getModule('bitpay');
  }

  private function getPaymentButton() {
    $bitpay_button =<<<BTN
<button id="bitpay-btn" type="submit">bitpay</button>
BTN;
    return $bitpay_button;
  }

  public function run()
  {
    $this->registerAsset();

    $this->prePaymentModal();
    $this->postPaymentModal();

    parent::run();

    echo $this->getPaymentButton();
  }

  private function prePaymentModal()
  {
    Modal::begin([
  		'headerOptions' => ['id' => 'bitpayModalHeader'],
  		'header' => '<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48c3ZnIHdpZHRoPSI4NiIgaGVpZ2h0PSIzMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+Qml0UGF5PC90aXRsZT48cGF0aCBkPSJNODYuMSw3LjRoLTQuNGwtMi42LDEwLjhsLTAuNCwxLjVjLTAuMywwLjEtMC41LDAuMS0wLjgsMC4yQzc3LjUsMjAsNzcuMSwyMCw3Ni42LDIwYy0wLjYsMC0xLTAuMS0xLjQtMC4zCgljLTAuMy0wLjItMC42LTAuNC0wLjctMC43Yy0wLjEtMC4zLTAuMi0wLjctMC4yLTEuMWMwLTAuNCwwLjEtMC45LDAuMi0xLjNsMS40LTUuNmwwLjktMy43aC00LjVMNzAuMiwxNmMtMC4zLDEuMS0wLjQsMi4xLTAuNCwyLjkKCWMwLDEsMC4xLDEuOCwwLjQsMi41YzAuMywwLjcsMC45LDEuMywxLjcsMS43YzAuOCwwLjQsMS45LDAuNiwzLjIsMC42YzEsMCwxLjktMC4xLDIuNi0wLjNoMC4xYy0wLjIsMC45LTAuNiwxLjYtMS4zLDIuMgoJYy0wLjcsMC42LTEuNiwwLjktMi44LDAuOWMtMC41LDAtMS4xLDAtMS41LTAuMWwtMC45LDMuNmMwLjYsMC4xLDEuMywwLjEsMiwwLjFjMS40LDAsMi42LTAuMiwzLjUtMC41YzEtMC4zLDEuOS0wLjgsMi43LTEuNAoJYzAuNy0wLjYsMS40LTEuNCwxLjktMi40YzAuNS0xLDAuOS0yLjEsMS4yLTMuM2wzLTEyLjlMODYuMSw3LjRMODYuMSw3LjR6IE02Ny42LDE2LjdjLTAuMywxLjEtMC40LDIuMy0wLjMsMy40CgljMC4xLDEuMiwwLjYsMi44LDEsMy43aC00LjNjLTAuNS0wLjktMC41LTEuMy0wLjYtMS42Yy0wLjYsMC41LTEuMiwwLjgtMS45LDEuMWMtMC43LDAuMy0xLjQsMC41LTIuMywwLjVjLTEsMC0xLjktMC4yLTIuNi0wLjUKCWMtMC43LTAuMy0xLjMtMC44LTEuOC0xLjRjLTAuNS0wLjYtMC44LTEuMy0xLTIuMWMtMC4yLTAuOC0wLjMtMS42LTAuMy0yLjZjMC0xLjQsMC4zLTIuNywwLjctMy44YzAuNS0xLjIsMS4yLTIuMywyLjEtMy4xCgljMC45LTAuOSwyLjktMi45LDYuNC0yLjloNi45TDY3LjYsMTYuN0w2Ny42LDE2Ljd6IE02NC40LDExLjJjLTIuMSwwLTIuNSwwLTMuMywwLjRjLTAuNiwwLjMtMS4xLDAuOC0xLjYsMS40CgljLTAuNCwwLjUtMC44LDEuMi0xLjEsMS45Yy0wLjMsMC43LTAuNCwxLjUtMC40LDIuM2MwLDEsMC4yLDEuNywwLjUsMi4zYzAuMywwLjYsMC45LDAuOCwxLjgsMC44YzAuNSwwLDAuOS0wLjEsMS4zLTAuMwoJYzAuNC0wLjIsMC44LTAuNSwxLjItMC45YzAtMC41LDAuMS0xLDAuMi0xLjZjMC4xLTAuNiwwLjItMS4xLDAuMy0xLjVMNjQuNCwxMS4yIE01Mi41LDEzLjljMCwxLjUtMC4zLDIuOC0wLjcsNAoJYy0wLjUsMS4yLTEuMiwyLjMtMiwzLjFjLTAuOSwwLjktMS45LDEuNi0zLDIuMWMtMS4yLDAuNS0yLjUsMC44LTMuOCwwLjhjLTAuNywwLTEuNC0wLjEtMi4xLTAuMmwtMS40LDUuNGgtNC40bDUuMS0yMS42aDUuOQoJYzEuMSwwLDIuMSwwLjIsMi44LDAuNWMwLjgsMC4zLDEuNSwwLjgsMiwxLjRzMC45LDEuMywxLjIsMi4xQzUyLjQsMTIuMiw1Mi41LDEzLDUyLjUsMTMuOUw1Mi41LDEzLjl6IE00MS42LDIwCgljMC4zLDAuMSwwLjgsMC4xLDEuMywwLjFjMC44LDAsMS41LTAuMSwyLjItMC40YzAuNi0wLjMsMS4yLTAuNywxLjctMS4yYzAuNS0wLjUsMC44LTEuMiwxLjEtMS45czAuNC0xLjYsMC40LTIuNXMtMC4yLTEuNi0wLjYtMi4yCgljLTAuNC0wLjYtMS4xLTAuOS0yLTAuOWgtMS44TDQxLjYsMjBMNDEuNiwyMHogTTMyLjQsMjBjLTAuNiwwLTEtMC4xLTEuNC0wLjNjLTAuMy0wLjItMC42LTAuNC0wLjctMC43Yy0wLjEtMC4zLTAuMi0wLjctMC4yLTEuMQoJYzAtMC40LDAuMS0wLjksMC4yLTEuM2wxLjQtNS42aDVsMC45LTMuN2gtNS4xbDEuMi00LjdMMjksMy40TDI2LDE2LjFjLTAuMywxLjEtMC40LDIuMS0wLjQsMi45YzAsMSwwLjEsMS44LDAuNCwyLjUKCWMwLjMsMC43LDAuOSwxLjMsMS43LDEuN2MwLjgsMC40LDEuOSwwLjYsMy4yLDAuNmMxLDAsMS45LTAuMSwyLjYtMC4zYzAuMSwwLDAuMiwwLDAuMy0wLjFsMC45LTMuOGMtMC4zLDAuMS0wLjYsMC4yLTAuOSwwLjIKCUMzMy4zLDIwLDMyLjksMjAsMzIuNCwyMEwzMi40LDIweiBNMjEuMSw3LjRsLTMuOSwxNi40aDQuNGwzLjktMTYuNEgyMS4xeiBNMjUuOSw1LjVsMC43LTIuOGgtNC40bC0wLjcsMi44SDI1Ljl6IE0xMS4zLDcuNAoJYzEsMCwxLjgsMC4yLDIuNSwwLjVzMS4zLDAuOCwxLjgsMS40YzAuNSwwLjYsMC44LDEuMywxLDIuMWMwLjIsMC44LDAuMywxLjYsMC4zLDIuNWMwLDEuNC0wLjMsMi43LTAuOCwzLjkKCWMtMC41LDEuMi0xLjIsMi4zLTIuMSwzLjJjLTAuOSwxLTEuOSwxLjYtMy4xLDIuMmMtMS4yLDAuNS0yLjUsMC44LTMuOCwwLjhINmMtMC41LDAtMSwwLTEuNi0wLjFjLTAuNi0wLjEtMS4yLTAuMi0xLjktMC40CglzLTEuMy0wLjQtMS45LTAuN0w1LjgsMS4xbDQuNi0wLjdMOC41LDguMWMwLjQtMC4yLDAuOC0wLjMsMS4yLTAuNEMxMC40LDcuNCwxMC44LDcuNCwxMS4zLDcuNEwxMS4zLDcuNHogTTcuMywyMC4yCgljMC43LDAsMS40LTAuMiwyLTAuNXMxLjItMC44LDEuNi0xLjRjMC41LTAuNiwwLjgtMS4yLDEuMS0xLjlzMC40LTEuNSwwLjQtMi4zYzAtMS0wLjItMS43LTAuNS0yLjNjLTAuMy0wLjUtMS0wLjgtMS45LTAuOAoJYy0wLjMsMC0wLjYsMC0xLDAuMWMtMC41LDAuMS0wLjgsMC4zLTEuMiwwLjZsLTIsOC4yYzAuNiwwLjEsMC44LDAuMSwwLjksMC4xQzYuOSwyMC4yLDcuMSwyMC4yLDcuMywyMC4yeiI+PC9wYXRoPjwvc3ZnPgo="/>',
  		'id' => 'bitpay-pre-modal',
  		'size' => 'modal-sm',
  		//keeps from closing modal with esc key or by clicking out of the modal.
  		// user must click cancel or X to close
  		//     'clientOptions' => ['backdrop' => 'static', 'keyboard' => FALSE]
    ]);
      echo '<div id="bitpay-pre-modal-content"><p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48c3ZnIHdpZHRoPSczMHB4JyBoZWlnaHQ9JzMwcHgnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHByZXNlcnZlQXNwZWN0UmF0aW89InhNaWRZTWlkIiBjbGFzcz0idWlsLXJpbmctYWx0Ij48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0ibm9uZSIgY2xhc3M9ImJrIj48L3JlY3Q+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDAiIHN0cm9rZT0iIzA0N2FiMyIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48L2NpcmNsZT48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgc3Ryb2tlPSIjZDdlMWU2IiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hvZmZzZXQiIGR1cj0iMnMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBmcm9tPSIwIiB0bz0iNTAyIj48L2FuaW1hdGU+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hhcnJheSIgZHVyPSIycyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIHZhbHVlcz0iMTUwLjYgMTAwLjQ7MSAyNTA7MTUwLjYgMTAwLjQiPjwvYW5pbWF0ZT48L2NpcmNsZT48L3N2Zz4="/>&nbsp;&nbsp;&nbsp;&nbsp;Loading Invoice...</p></div>';
    Modal::end();
  }

  private function postPaymentModal()
  {
    Modal::begin([
  		'headerOptions' => ['id' => 'bitpayPostModalHeader'],
  		'header' => '<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48c3ZnIHdpZHRoPSI4NiIgaGVpZ2h0PSIzMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+Qml0UGF5PC90aXRsZT48cGF0aCBkPSJNODYuMSw3LjRoLTQuNGwtMi42LDEwLjhsLTAuNCwxLjVjLTAuMywwLjEtMC41LDAuMS0wLjgsMC4yQzc3LjUsMjAsNzcuMSwyMCw3Ni42LDIwYy0wLjYsMC0xLTAuMS0xLjQtMC4zCgljLTAuMy0wLjItMC42LTAuNC0wLjctMC43Yy0wLjEtMC4zLTAuMi0wLjctMC4yLTEuMWMwLTAuNCwwLjEtMC45LDAuMi0xLjNsMS40LTUuNmwwLjktMy43aC00LjVMNzAuMiwxNmMtMC4zLDEuMS0wLjQsMi4xLTAuNCwyLjkKCWMwLDEsMC4xLDEuOCwwLjQsMi41YzAuMywwLjcsMC45LDEuMywxLjcsMS43YzAuOCwwLjQsMS45LDAuNiwzLjIsMC42YzEsMCwxLjktMC4xLDIuNi0wLjNoMC4xYy0wLjIsMC45LTAuNiwxLjYtMS4zLDIuMgoJYy0wLjcsMC42LTEuNiwwLjktMi44LDAuOWMtMC41LDAtMS4xLDAtMS41LTAuMWwtMC45LDMuNmMwLjYsMC4xLDEuMywwLjEsMiwwLjFjMS40LDAsMi42LTAuMiwzLjUtMC41YzEtMC4zLDEuOS0wLjgsMi43LTEuNAoJYzAuNy0wLjYsMS40LTEuNCwxLjktMi40YzAuNS0xLDAuOS0yLjEsMS4yLTMuM2wzLTEyLjlMODYuMSw3LjRMODYuMSw3LjR6IE02Ny42LDE2LjdjLTAuMywxLjEtMC40LDIuMy0wLjMsMy40CgljMC4xLDEuMiwwLjYsMi44LDEsMy43aC00LjNjLTAuNS0wLjktMC41LTEuMy0wLjYtMS42Yy0wLjYsMC41LTEuMiwwLjgtMS45LDEuMWMtMC43LDAuMy0xLjQsMC41LTIuMywwLjVjLTEsMC0xLjktMC4yLTIuNi0wLjUKCWMtMC43LTAuMy0xLjMtMC44LTEuOC0xLjRjLTAuNS0wLjYtMC44LTEuMy0xLTIuMWMtMC4yLTAuOC0wLjMtMS42LTAuMy0yLjZjMC0xLjQsMC4zLTIuNywwLjctMy44YzAuNS0xLjIsMS4yLTIuMywyLjEtMy4xCgljMC45LTAuOSwyLjktMi45LDYuNC0yLjloNi45TDY3LjYsMTYuN0w2Ny42LDE2Ljd6IE02NC40LDExLjJjLTIuMSwwLTIuNSwwLTMuMywwLjRjLTAuNiwwLjMtMS4xLDAuOC0xLjYsMS40CgljLTAuNCwwLjUtMC44LDEuMi0xLjEsMS45Yy0wLjMsMC43LTAuNCwxLjUtMC40LDIuM2MwLDEsMC4yLDEuNywwLjUsMi4zYzAuMywwLjYsMC45LDAuOCwxLjgsMC44YzAuNSwwLDAuOS0wLjEsMS4zLTAuMwoJYzAuNC0wLjIsMC44LTAuNSwxLjItMC45YzAtMC41LDAuMS0xLDAuMi0xLjZjMC4xLTAuNiwwLjItMS4xLDAuMy0xLjVMNjQuNCwxMS4yIE01Mi41LDEzLjljMCwxLjUtMC4zLDIuOC0wLjcsNAoJYy0wLjUsMS4yLTEuMiwyLjMtMiwzLjFjLTAuOSwwLjktMS45LDEuNi0zLDIuMWMtMS4yLDAuNS0yLjUsMC44LTMuOCwwLjhjLTAuNywwLTEuNC0wLjEtMi4xLTAuMmwtMS40LDUuNGgtNC40bDUuMS0yMS42aDUuOQoJYzEuMSwwLDIuMSwwLjIsMi44LDAuNWMwLjgsMC4zLDEuNSwwLjgsMiwxLjRzMC45LDEuMywxLjIsMi4xQzUyLjQsMTIuMiw1Mi41LDEzLDUyLjUsMTMuOUw1Mi41LDEzLjl6IE00MS42LDIwCgljMC4zLDAuMSwwLjgsMC4xLDEuMywwLjFjMC44LDAsMS41LTAuMSwyLjItMC40YzAuNi0wLjMsMS4yLTAuNywxLjctMS4yYzAuNS0wLjUsMC44LTEuMiwxLjEtMS45czAuNC0xLjYsMC40LTIuNXMtMC4yLTEuNi0wLjYtMi4yCgljLTAuNC0wLjYtMS4xLTAuOS0yLTAuOWgtMS44TDQxLjYsMjBMNDEuNiwyMHogTTMyLjQsMjBjLTAuNiwwLTEtMC4xLTEuNC0wLjNjLTAuMy0wLjItMC42LTAuNC0wLjctMC43Yy0wLjEtMC4zLTAuMi0wLjctMC4yLTEuMQoJYzAtMC40LDAuMS0wLjksMC4yLTEuM2wxLjQtNS42aDVsMC45LTMuN2gtNS4xbDEuMi00LjdMMjksMy40TDI2LDE2LjFjLTAuMywxLjEtMC40LDIuMS0wLjQsMi45YzAsMSwwLjEsMS44LDAuNCwyLjUKCWMwLjMsMC43LDAuOSwxLjMsMS43LDEuN2MwLjgsMC40LDEuOSwwLjYsMy4yLDAuNmMxLDAsMS45LTAuMSwyLjYtMC4zYzAuMSwwLDAuMiwwLDAuMy0wLjFsMC45LTMuOGMtMC4zLDAuMS0wLjYsMC4yLTAuOSwwLjIKCUMzMy4zLDIwLDMyLjksMjAsMzIuNCwyMEwzMi40LDIweiBNMjEuMSw3LjRsLTMuOSwxNi40aDQuNGwzLjktMTYuNEgyMS4xeiBNMjUuOSw1LjVsMC43LTIuOGgtNC40bC0wLjcsMi44SDI1Ljl6IE0xMS4zLDcuNAoJYzEsMCwxLjgsMC4yLDIuNSwwLjVzMS4zLDAuOCwxLjgsMS40YzAuNSwwLjYsMC44LDEuMywxLDIuMWMwLjIsMC44LDAuMywxLjYsMC4zLDIuNWMwLDEuNC0wLjMsMi43LTAuOCwzLjkKCWMtMC41LDEuMi0xLjIsMi4zLTIuMSwzLjJjLTAuOSwxLTEuOSwxLjYtMy4xLDIuMmMtMS4yLDAuNS0yLjUsMC44LTMuOCwwLjhINmMtMC41LDAtMSwwLTEuNi0wLjFjLTAuNi0wLjEtMS4yLTAuMi0xLjktMC40CglzLTEuMy0wLjQtMS45LTAuN0w1LjgsMS4xbDQuNi0wLjdMOC41LDguMWMwLjQtMC4yLDAuOC0wLjMsMS4yLTAuNEMxMC40LDcuNCwxMC44LDcuNCwxMS4zLDcuNEwxMS4zLDcuNHogTTcuMywyMC4yCgljMC43LDAsMS40LTAuMiwyLTAuNXMxLjItMC44LDEuNi0xLjRjMC41LTAuNiwwLjgtMS4yLDEuMS0xLjlzMC40LTEuNSwwLjQtMi4zYzAtMS0wLjItMS43LTAuNS0yLjNjLTAuMy0wLjUtMS0wLjgtMS45LTAuOAoJYy0wLjMsMC0wLjYsMC0xLDAuMWMtMC41LDAuMS0wLjgsMC4zLTEuMiwwLjZsLTIsOC4yYzAuNiwwLjEsMC44LDAuMSwwLjksMC4xQzYuOSwyMC4yLDcuMSwyMC4yLDcuMywyMC4yeiI+PC9wYXRoPjwvc3ZnPgo="/>',
  		'id' => 'bitpay-post-modal',
  		'size' => 'modal-sm',
  		//keeps from closing modal with esc key or by clicking out of the modal.
  		// user must click cancel or X to close
  		//     'clientOptions' => ['backdrop' => 'static', 'keyboard' => FALSE]
    ]);
      echo '<div id="bitpay-post-modal-content"><p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48c3ZnIHdpZHRoPSczMHB4JyBoZWlnaHQ9JzMwcHgnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHByZXNlcnZlQXNwZWN0UmF0aW89InhNaWRZTWlkIiBjbGFzcz0idWlsLXJpbmctYWx0Ij48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0ibm9uZSIgY2xhc3M9ImJrIj48L3JlY3Q+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDAiIHN0cm9rZT0iIzA0N2FiMyIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48L2NpcmNsZT48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgc3Ryb2tlPSIjZDdlMWU2IiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hvZmZzZXQiIGR1cj0iMnMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBmcm9tPSIwIiB0bz0iNTAyIj48L2FuaW1hdGU+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hhcnJheSIgZHVyPSIycyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIHZhbHVlcz0iMTUwLjYgMTAwLjQ7MSAyNTA7MTUwLjYgMTAwLjQiPjwvYW5pbWF0ZT48L2NpcmNsZT48L3N2Zz4="/>&nbsp;&nbsp;&nbsp;&nbsp;Please wait...</p></div>';
    Modal::end();
  }

  protected function registerAsset()
  {
    BitpayAsset::register($this->view);

    \Yii::$app->view->registerJs('var invoiceId = "'.$this->invoice_id.'"',  \yii\web\View::POS_HEAD);
    \Yii::$app->view->registerJs('var invoiceAmount = "'.$this->invoice_amount.'"',  \yii\web\View::POS_HEAD);
    \Yii::$app->view->registerJs('var clientId = "'.$this->customer_id.'"',  \yii\web\View::POS_HEAD);
    \Yii::$app->view->registerJs('var bitpayInvoiceId = ""',  \yii\web\View::POS_HEAD);

    \Yii::$app->view->registerJs('var createInvoiceAction = "'.  \Yii::$app->urlManager->createUrl(['/bitpay/checkout/create-invoice']).'"',  \yii\web\View::POS_HEAD);
    \Yii::$app->view->registerJs('var queryInvoiceAction = "'.  \Yii::$app->urlManager->createUrl(['/bitpay/checkout/query-invoice']).'"',  \yii\web\View::POS_HEAD);
  }
}
